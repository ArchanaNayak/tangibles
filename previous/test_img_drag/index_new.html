<!DOCTYPE html>
<html lang="en" manifest="cache.manifest">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Touch Tracker Marker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name = "apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png" />
    <meta name="description" content="">
    <meta name="HandheldFriendly" content="True">
    
    <style type="text/css">
      body { margin: 0px; overflow: hidden; background-color: #fff; }
    </style>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.2.min.js"></script>

  </head>
  <body>    
    <div style="position:relative; z-index:1000;">
          <input type="submit" value="Set" id="set">
    </div>
    <div id="container" style="border: 1px solid #000000; bottom: 0; left: 0; overflow: hidden; position: absolute; right: 0; top: 0;"></div>

    <script type="text/javascript">
    var touches = [];
    var w = 0;
    var h = 0;
    var img_src;
    var nw = window.innerWidth;
    var nh = window.innerHeight;

    var touchPoints = new Array();   // current detected touch points

    if ((w != nw) || (h != nh)) {
      w = nw;
      h = nh;
    }

    var stage = new Kinetic.Stage({
      container: "container",
      width: w,
      height: h
    });
    
    var layer = new Kinetic.Layer();
    var layer1 = new Kinetic.Layer();

    document.getElementById("set").onclick = function() {
        var imageObj = new Image();
        imageObj.onload = function() {
          drawImage(this);
        }
      imageObj.src = "img/image003.png";
    }; 

    /* touch */
    function DetectTouchPoints(evt){
      while (touchPoints.length > 0) {
        touchPoints.pop();
      }

      touches = evt.touches;
      var i, len = touches.length;
      for (i=0; i<len; i++) {
        var touch = touches[i];
        var px = touch.pageX;
        var py = touch.pageY;

        var temp = new Array(px, py);
        touchPoints.push(temp);
      }
    }


    /* 
     * drawImage - Load the image with the right width and height
     *             at the right location
     */
    function drawImage(imageObj) { 
        
        var w = 340;
        var h = 140;

        // darth vader
        var darthVaderImg = new Kinetic.Image({
            image: imageObj,
            x: 100,
            y: 100,
            width: w,
            height: h,
            offsetX: w/2,
            offsetY: h/2,
            draggable: true
        });

        // add cursor styling
        darthVaderImg.on('mouseover', function() {
            document.body.style.cursor = 'pointer';
        });
        darthVaderImg.on('mouseout', function() {
            document.body.style.cursor = 'default';
        });
        darthVaderImg.on('dragstart', function(event) {
          DetectTouchPoints(event);
          var i = 0;
          while (i < touchPoints.length) {
            console.log("x,y: "+touchPoints[i][0]+','+touchPoints[i][1]);
            i++;
          }
          
        });
        darthVaderImg.on('dragmove', function(event) {
          DetectTouchPoints(event);
          var i = 0;
          var sumX = 0, sumY = 0;
          while (i < touchPoints.length) {
            console.log("x"+i+",y"+i+": "+touchPoints[i][0]+','+touchPoints[i][1]);
            sumX = touchPoints[i][0];
            sumY = touchPoints[i][1];
            i++;
          }

          this.setAttrs({x:sumX, y:sumY});
          this.draw();
        });

        layer1.add(darthVaderImg);
        layer1.draw();
    }

stage.getContent().addEventListener('touchstart', function(event) {

        nw = window.innerWidth;
        nh = window.innerHeight;

        if ((w != nw) || (h != nh)) {
          w = nw;
          h = nh;
          stage.width(w);
          stage.height(h);
        }

        event.preventDefault();
        touches = event.touches;
        var i, len = touches.length;
        for (i=0; i<len; i++) {
          var touch = touches[i];
          var px = touch.pageX;
          var py = touch.pageY;
          console.log('px: '+px);
          console.log('py: '+py);
          var c = new Kinetic.Circle({
            radius: 10,
            fill: '#6eb3ca',
            x: px,
            y: py
          });
          layer.add(c);
          layer.draw();
        }
        console.log('normal start');

        
    });

    stage.getContent().addEventListener('touchend', function() {

        event.preventDefault();
        if (layer.hasChildren()) {
          layer.destroyChildren();
          layer.clear();
        }

    });

    stage.getContent().addEventListener('touchmove', function(event) {

        event.preventDefault();
        touches = event.touches;
        layer.destroyChildren();
          
        var i, len = touches.length;
        for (i=0; i<len; i++) {
            var touch = touches[i];
            var px = touch.pageX;
            var py = touch.pageY;

            //ImgX = px;
            //ImgY = py;

            var c = new Kinetic.Circle({
              radius: 10,
              fill: '#6eb3ca',
              x: px,
              y: py
            });
            layer.add(c);
            layer.draw();
        }
        //stage.draw();
    
    });


     stage.add(layer);
     stage.add(layer1);

  </script>
  </body>

  
</html>
